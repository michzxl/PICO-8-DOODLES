pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
-- basic template

#include maths.lua
#include poly.lua
#include vec.lua
#include subpixel.lua
#include tex.lua

function _init()
	t=0

	

	seg = 5
	size = 128/seg
	total_size = seg * size

	base_ps = {}

	for ty=0,seg do
		base_ps[ty] = {}
		local base_ps_ty = base_ps[ty]
		for tx=0,seg do
			local v = vec(tx*size - total_size/2, ty*size - total_size/2)
			base_ps_ty[tx] = v
		end
	end
	ps = base_ps

	for mx=0,15 do
		for my=0,15 do
			mset(mx, my,
				mx + my*16
			)
		end
	end

	pal(7,7,1)
	pal(1,1+128,1)
	pal(8,12+128,1)
	pal(9,14+128,1)
	pal(15,1,1)
	cls(1)

	for x=0,127 do
		for y=0,127 do
			sset(x,y,rnd(3))
		end
	end

	for i=1,4000 do
		--navy & white
		dr(rnd(128),rnd(128),rnd(1)<0.5 and 1 or 7)
	end
	for i=1,1000 do
		dr(rnd(128),rnd(128),rnd(2)+8)
	end
end

function dr(x,y,c)
	sset(x,y-1,c)
	sset(x,y+1,c)
	sset(x-1,y,c)
	sset(x+1,y,c)
end

function _update()
	--	cls(7)
	t+=1/30

	for i=1,650 do
		x,y = rnd(128),rnd(128)

		-- if btn(4) then
		-- 	dr(x,y,1)
		-- elseif btn(5) then
		-- 	dr(x,y,7)
		-- else
		do
			--edges may create navy/white
			if ((x<=1 or flr(y)>=126) and rnd(1)<0.01) then
				sset(x,y,rnd(1)<0.5 and 1 or 7)
			end

			--if nearby pixels are same,
			--maybe change color.
			--will break down large areas
			local p=sget(x,y)
			if sget(x+1,y)==p
						and sget(x,y-1)==p
						and rnd(1)<0.005 then
				dr(x,y,rnd(2) + 8)
			end

			--propel the color.
			if rnd(1)<0.75 then
				dr(x+1,y-1,p)
			else
				dr(x,y,p)
			end
		end
	end

	angs = vec(
		-1/16,
		1/16,
		0
	)
	local ux,uy,uz = vec.u_rot_yxz(angs)

	local rot_ps = {}
	for ty=0,#base_ps do
		local row = base_ps[ty]
		rot_ps[ty] = {}
		for tx=0,#base_ps do
			local v = base_ps[ty][tx]

			local w = ux*v.x + uy*v.y + uz*v.z
			local u = 16*mid(-1,1,sin(t/6 + v.y/128))

			rot_ps[ty][tx] = {
				vec(
					(w.x + v.x) + u,
					(w.y + v.y) + u,
					w.z
				),
				v
			}
		end
	end

	draw_ps(rot_ps)
end

function rotate_ps(ps, angs)
	local ux,uy,uz = vec.u_rot_yxz(angs)

	local rot_ps = {}
	for ty=1,#ps do
		local row = ps[ty]
		rot_ps[ty] = {}
		for tx=1,#ps[1] do
			local v = ps[ty][tx]

			w = ux*v.x + uy*v.y + uz*v.z

			rot_ps[ty][tx] = w
		end
	end

	return rot_ps
end

function draw_ps(ps)
	local y_forward = angs.x%1 > 0.5
	local x_forward = angs.y%1 > 0.5

	local y_start, y_end, y_step
	if y_forward then
		y_start = 0
		y_end = #ps
		y_step = 1
	else
		y_start = #ps
		y_end = 0
		y_step = -1
	end

	local x_start, x_end, x_step
	if x_forward then
		x_start = 0
		x_end = #ps
		x_step = 1
	else
		x_start = #ps
		x_end = 0
		x_step = -1
	end

	for ty=y_start,y_end,y_step do
		for tx=x_start,x_end,x_step do
			local v = ps[ty][tx][1]
			local v_orig = ps[ty][tx][2]
			local w = v_orig + vec(total_size/2, total_size/2)
			v = v + vec(64,64)
			--v = v + vec(64,64)

			if tx~=#ps and ty~=#ps then
				local v_right = ps[ty][tx+1][1] + vec(64,64)
				local v_down = ps[ty+1][tx][1] + vec(64,64)
				local v_across = ps[ty+1][tx+1][1] + vec(64,64)
				
				--polyf({v-vec(64,64), v_right, v_across, v_down}, vec(64,64), 0)
				--polyv({v-vec(64,64), v_right, v_across, v_down}, vec(64,64), 7)

				tquad(
					v.x,v.y,
					v_right.x,v_right.y,
					v_across.x,v_across.y,
					v_down.x,v_down.y,
					w.x/8,w.y/8,
					size/8,size/8
				)
			end
		end
	end
end

__gfx__
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
777777777777777777777777777777777777777777777777777777777777777f4677677777777777777777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777777777777777777777779646a777767777777777777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777777777777777777777777a6a5d77767777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777f967679ad69457d6777777afafa667777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777777777777777faf676465f4d57d4af779a7a6a69d66777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777774fd6994fa5655494545da5aa9aa66777ad777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777777777777f45aa64da95554944f5d75aa955d777766777777777777777777777777777777777777777777
777777777777777777777777777777777777777777777777777a6a6a54694d94155549a6aa599da4a6a6ad967a77777777777777777777777777777777777777
777777777777777777777777777777777777777777777777776a4ad495a545550054444a455644a6544d54565d77777777777777777777777777777777777777
77777777777777777777777777777f7777777777677777f67aada4aaa455505555555df5ad5455a590add57d6467777777777777777777777777777777777777
77777777777777777777777777777f9777777776477777a9f67545aa44f55555505555555555514fd5d5dd655677777777777777777777777777777777777777
77777777777777777777777777779aaf9f7777aaa776ad4a47faa45d55455145101555555d5551555d65a57d5677777777777777777777777777777777777777
77777777777777777777777777779aaf9f7777aaa776ad4a47faa45d55455145101555555d5551555d65a57d5677777777777777777777777777777777777777
77777777777777777777777777794449965f7f4456fa464d67645955a155545515555505555d1555577656767677777777777777777777777777777777777777
77777777777777777777777777afd44d5f77774a5a469aa954f595955554155555050511555540555d6556667777777777777777777777777777777777777777
777777777777777777777777779a55daa77a7a9945a49aad55aa99454555550545005500015d65d15dd967677777777777777777777777777777777777777777
777777777777777777777777aa9a96a646aaaaa44955949d455455545050000555555550d1554d5556655d777777777777777777777777777777777777777777
7777777777777777777777fa94696a454999f4d45655a4565a5555550551d5015555115055d55776d76767777777777777777777777777777777777777777777
7777777777777777777777a9a9a996f5aad4a4665945d55da5da5555001005555050550055057776777777777777777777777777777777777777777777777777
7777777777777777777777744955da66a96d94495654555555545555510055155d0d5d5655516777777777777777777777777777777777777777777777777777
7777777777777777777777794dd5aaaaa46649445d55d51554496455501505055551565555077777747777777777777777777777777777777777777777777777
77777777777777777777776a576da9aa55945d954a65555aaf95a4f5500551555055505505555766f56777777777777777777777777777777777777777777777
777777777777777777777777d6da995ada99459aad555045944946550055555550005555156555d66556766d7777766777777777777777777777777777777777
77777777777777777777fa97674a494dd94d4a55d45455a6655455a4d5555555005500551dd5d5d55556775dd777d555a9677777777777777777777777777777
7777777777777777777794a6a44944a5455d55a45555aa54555544454515551515511551515d1dd65554565556775556dd77af77777777777777777777777777
7777777777777777777765aaaa455454aa4d5dd55aa6f4d545a5455555556050515051550dd51767d5577555556a75a6f6d77777777777777777777777777777
77777777777777777776a5aa4a964454a4944d5d4a55555554555505545f651505551055d565776d7a7765d5596aaa9d57677677777777777777777777777777
7777777777777777779aa6a9a4af6aa95545555a955555044f55056d6441606505166555055d6659575d666ddd4a449999a57777777777777777777777777777
77777777777777777f45a456a54dd5f4a455554455555055550510550015555d550655555d5aa9a4d55dadd55dda94aa56459a7774d777777777777777777777
7777777777777777774dadaf55d64d55545555545555550055555555d7650551007d055955465a54d545655d46944545a5444a46a55677777777777777777777
77777777777777777766d65459d4545d555555555555555550150600106555556dd5555655a495554555595d56d6544555594545655567777777777777777777
777777777777777777775454945455655555555555d55455010555505050505575575115a45dd55559a55555dd6d49d55a4455454f4777777777777777777777
7777777777777777779766445a564541555555d004555105105150150015167055555f5a465a55554555555f5554a4545a555554565d77777777777777777777
7777777777777776aaa55d455544d555555555055555500015000010005550775005555595dd45aad5455145f545445555a44455544457777777777777777777
777777777777777aa4944a54555555555155555555d555000001001001d650d6d055509455945555555a505a5495a9955555455555f467777777777777777777
77777777777776766a5555445566d455541aa705565560505550000005ddd607610775945994555a45a55aa54444df44a5555555555555797777777777777777
7777777777777f76a575a5a55555d5d5511557751150550055550d0000155d55d05d54455a5f55554a5545494545694a44d54555045556d9a777777777777777
7777777777777a6764455a45556556755055505554155051500500000001115050d666d5a545555544a54aa55445545555540554155555556666777777777777
77777777777777d46a944545aad777750555555500110550500005000501515500676d5a5544505a455555a5a445a555055555555151055aa656677777777777
77777777777749aa4aa455a4a65d0d5555a55155550555055555010050aa055055674adad55555555555555ad551555555505115505555555f45777777777777
777777777777f4ad5d5455444ad5745445a5555055555505500500000195945455d64ddd545555515550550554555459505595555555550055d7777777777777
777777777777aa655495d559d955565555515550550050000100505010a6654501d4d45549551d555501555d55054554d555440100505500056d777777777777
77777777777776545a45445555657d555550555550005551501005156a9455599495445055455555d51150505005445554555555545505551566677777777777
7777777777777755545a555556676655555555555510555501511550599d4a9a99454555595555a55506045545440555545450555d5055555546777777777777
77777777777777655455555056d775555455550055105505550150505554559455555d445a01550555500105054a55555505055500055565d777777777777777
77777777777777d5a5495554dd665545055550155555550005551050a49555454555d45555555510550010050051555155050555155d55dd7777777777777777
777777777777776555ad55556dd55555554517555555500555501500ad54955545554594f9515551510d15550155150555540555555d6a55d777777777777777
77777777777777f55555557d5d05576d5555565555055005555055055a594545d55555545d6515905505001d554550055555d555500d55556767777777777777
777777777777777655dd557561105555d550550505155100510005101555a55d555555450555a55a551d01555555555555555555550565d75666777777777777
77777777777777776755667d55550555545555550050055000051051045a5555455550555555a9a4455010000554555555555555500555d65777777777777777
77777777777777777777777705055114d555d0000050100000010000505a455545555555551055a55050050555554555555551d5560756555677777777777777
7777777777777777777777757500555a555551d15100005505501055504444555555555555154554405d15500555556505555055555766d67577777777777777
777777777777777777777777755d5115555655105550500551010050505104555d55455554555d555445555505105556d55551555555545566d6777777777777
777777777777777777777777555500545065d5550051000005511050d0050445555555a4d5a45a94555055d6d55175555755055555555d655556677777777777
777777777777777777777777d555159555550555015050551515105055005405045555555554a44555555d777550055550550555555555555d554a7777777777
777777777777777777777777d555159555550555015050551515105055005405045555555554a44555555d777550055550550555555555555d554a7777777777
777777777777777777777777766d5555d4550050010500155001d555001050055555555555519444555565765051555056055d00505555646d554d7777777777
7777777777777777777777777777d5556555500d0167555555100055005505055555515d5555554566d555565551105d6555555555555dd7d655d67777777777
777777777777777777777777777776669d555100500000055000500150705150155555555555465575d6665767005555550055565555dd56d6d6777777777777
777777777777777777777777777777777675555d50000055050011500001d5000605550d1d7d5d66667065777d555d7d55555557556d6d5d6765d67777777777
7777777777777777777777777777777777d555550101077055010000051555000005550055d7577760576d57605655d5d5556557d56656d6775d577777777777
7777777777777777777777777777777d67595605500075d75505010005570005000555055dd56775655107dd66576d50505556156d5565557666677777777777
777777777777777777777777777777d65d575d65554d76515050055505005000000d55d565d67767566505107d550d5d555555555dddd56d7775777777777777
77777777777777777777777777777777dd65556555455155511d50015000500000060060760577777661057505d0d776d00075557777566d5777777777777777
7777777777777777777777777777777645a5667505500555560d500051055000011570150555d77777d57d5655550657d0555616567777775d77777777777777
77777777777777777777777777777777776555dd555515551515510011500000015011105505777775555550155d6777550656ddd67777776577777777777777
77777777777777777777777777777777d46555015555505505005100d555111001000500505506571dd5555d655557665667d5d6777777777777777777777777
7777777777777777777777777777777765645105551050155000d000115056d50000000005155516556d57555557566d57501d77777777777777777777777777
777777777777777777777777777777777677571555105005055005011510001501705555501001500155555566556777d677d777777777777777777777777777
77777777777777777777777777777777766745d515d00051000510550001151010111505651005051767566677775777777d7777777777777777777777777777
777777777777777777777777777777777767d55d555d15015115055110051055150150000d501000575655777775777777777777777777777777777777777777
7777777777777777777777777777777777777d555550d777055015651100051111000d010500500d777777667677777777777777777777777777777777777777
777777777777777777777777777777777777777655d5567775056100051d0115005511000000000d677777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777757d1676655d550011500115511011000001070dd77777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777d6d6d77d50705061151011555005000000000d6777777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777776675557151615501555011000500000dd75677777777777777777777777777777777777777777777777
777777777777777777777777777777777777777777777567d7555501555001105510000110005050577777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777775d615010001551010000000010d0001056557777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777765550051155115100000150510105555577777777777777777777777777777777777777777777777
777777777777777777777777777777777777777777777776d555505505115550015000050100110d577777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777775d565505550550510000005500500100777777777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777776555555555557615100010005d705d0d777777777777777777777777777777777777777777777777777
777777777777777777777777777777777777777777777755dd5555d0577051151000177077777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777775107655575d77705115007757777777777777777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777777155d775675677755555677777777777777777777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777777d557d77567777775551777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777775d51777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777775d50777777777777777777777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777777777777777777777d515777777777777777777777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777777777777777777777d551777777777777777777777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777777777777777777777d155777777777777777777777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777777777777777777777d555777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777775015777777777777777777777777777777777777777777777777777777777777777
777777777777777777777777777777777777777777777777777777777777755d5777777777777777777777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777777777777777777777555d777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777775ddd777777777777777777777777777777777777777777777777777777777777777
777777777777777777777777777777777777777777777777777777777777756dd577777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777775555577777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777775555577777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777775d55177777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777775dd5177777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777775ddd577777777777777777777777777777777777777777777777777777777777777
777777777777777777777777777777777777777777777777777777777777756d5577777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777776d55177777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777776d5d177777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777776dd5577777777777777777777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777777777777777777777ddd5577777777777777777777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777777777777777777777dddd577777777777777777777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777777777777777777777ddd5577777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777776ddd577777777777777777777777777777777777777777777777777777777777777
7777777777777777777777777777777777777777777777777777777777777d55ddd7777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777776dd1d67777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
