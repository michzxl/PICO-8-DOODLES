pico-8 cartridge // http://www.pico-8.com
version 29
__lua__

#include maths.lua
#include vec.lua
#include poly.lua
#include palettes.lua
#include util.lua

function _init()
	dt=1/30
	t=0
	tf=0

	cls()

	fill = 0
end

function _update()
	-- cls()
	t+=dt
	tf+=1

	st4 = sin(t/4)
	st16 = sin(t/16)
	nc = 16 + 15*st16

	do 
		local polys,points = polly.cube(128)
		local angs = vec(t/16, t/9, t/8)

		local ux,uy,uz = angs:u_rot_yxz()
		foreach(points, function(p) 
			p:set( ux*p.x + uy*p.y + uz*p.z )
		end)

		for key,pol in ipairs(polys) do
			local normal = polly.normal(pol)
			if normal.z<1 then
				local light = -normal.y

				-- polyf(pol, vec(64,64), 0)
				polyv(pol, vec(64,64), palettewave(t, palettes[curr_pal], 16))
			end
		end
	end

	fill += pow2(rnd(16))
	bk=8
	for i=1,75 do
		ox=rnd(128+bk)-8
		oy=rnd(128+bk)-8
		local color = 0
		
		if (vec(ox,oy)-vec(64,64)):magn()<40 then
			color = 2
			
		end
		fillp(fill)
		rectfill(ox,oy,ox+bk-1,oy+bk-1,color)
		fillp()
	end

	hr = 9
	if t%8<4 then hr=1.02 end
	hy = 0
	if t%8>4 then hy=tf/2%2 end

	for n=1,nc do
		local cen = vec(
			64 + 16*cos(n/20 + t/2 + nc/32) , 
			64 - 8*cos(cos(n/20 + t/2)/16) + 7*sin(t + n/30)
		)

		local shape = {}
		local sides = 7 + 5 * sin(n/hr + t/2)
		local r = 24 + 16*sin(n/20) - 4*st4
		

		for _i=1,sides do
			local i = (_i-1) / sides
			local ang = i + n*4 + t/2 + hy
			local rf = r + sin(t/8 + ang*2)*8*(st16+1)/2

			add(shape, vec.frompolar(ang,rf))
		end

		polyf(shape,cen,0)
		polyv(shape, cen, palettewave(t+n, palettes[curr_pal], 16))
	end
end

function palettewave(x, palette, period)
	return ctriwave(x, #palette/2+1.1, #palette-1.2, period)
end

function pow2(n)
	local r = 1
	for i=1,n do
		r *= 2
	end
	return r
end
__label__
0000000000000000000000000000ii00000ii00000000000000000ii00000000ii0i00000000000000000000000000000000000000000000i000ii0000000000
000000000000000000000000000000ii00000ii00000000000000000i000000iiiii0000000000000000000000000000000000000000000ii00000ii00000000
00000000000000000000000000000000ii00000ii00000000000ii000ii0000ii0ii00000000000000000000000000000000i0i00000000i0ii0ii00ii000000
0000000000000000000000000000000000ii00000ii00000i00000i0000i000iiii0iiii00000000000000000000000000000ii000000000ii0i00ii00000000
000000000000000000000000000000000000ii00000ii0000ii0000ii00000iiiiiiiii00000000000000000000000000000ii000000000ii0i00000ii00ii00
00000000000000000000000000000000000000ii00000ii0000ii000000000ii0i0ii0i00000000000000000000000000000i0i00000000i0i00000000ii00ii
0000000000000000000000000000000000000000ii00000ii0000ii0000000ii0iiiiii0000000000000000000000000000000000000000000ii000000000000
000000000000000000000000000000000000000000iii000oii0000i00000iii0ii0iii000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000ii0iiiii000ii000ii00i0ii0i0000000000000000ii0i00000000000000000i0i0000000000ii00000
00000000000000000000000000000000000000000000000iiii00ii000ii0ii00i000io000000000000000000i0000000000000000000i0000000000000i00i0
0000000000000000000000000000000000000000000000000ii0100ii000ii0000i00oi0000000000000000000i000000000000000000000000000000000ii0i
000000000000000000000000000000000000000000000000000i11000ii0iiii000iio000000000000000000i0000000000000000000000000000000000000ii
00000000000000000000000000000000000000000000000000001010000iiiiiii0i0ii000i00000000000000i00000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000001010i008iii000iii00oi00ii0000000000000i00000000000000000000000000000000000i0
000000000000000000000000000000000000000000000000000010010i8088iii00ii00ooi0i000000000000i00000000000000000000000000i00000000000i
00000000000000000000000000000000000000000000000000001000108000880ii00iiooiii0000000000000i000000000000000000000000000i00i0000000
000000000000000000000000000000000000000000000000000010000100000088i000iii000i000u000000000ii000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000100000100000008000i00000i0uu0u0000000i00000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000001000000100000008ii0000000i0000u0000000i0000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000010000001000000ii000000000i00000u00000000000000000000000000000000000000000000
0000000000000000000000000000000h000000000000000008801000000010000i000000000000i0000u00000000000000000000000000000000000000000000
0000000000000000000000000000000hhh00000000000000011810000000010ii0000000000000i00000u000oo00000000000000000000000000000000000000
0000000000000000000000000000000h00hh0000000000000001000000000010000000000000000i00000u000o00000000000000000000000000000000000000
00000000000000000000000000000000h000hh00001000000001000000000001000000000000000i000000u000o0000000000000000000000000000000000000
00000000000000000000000000000000h00000hhooooooooooo10000000000001000000000000000i000000u00o0080800000000000000000000000i00000000
00000000000000000000000000000000h0000000h000000000010000000000001000000000000000ioooooooooooo00800000000000000000000000000000000
00000000000000000000000000000000h00000000hh00000000100000000000001000000000000000i0000000000o00800000000000000000000000000000000
00000000000000000000000000000000h0000000000hh000000100000000000000100000000000000i00000000000ov00000000000000000000000000000iiii
00000000000000000000000000000000h000000000000hh0000100000000000000010000000000000i00000000000ov0000000000000000iiiiiiiiiiiii0000
000000000000000000000000000000000h0000000000000hh0i1000000000000000010000000000000i0000000000o0v0000000iiiiiiii000iiiiiiiiiiiiii
000000000000000000000000000000000h000000000000000h01000000000000000001000000000000i0000000000o0v00000000000iiiiiii00000000000000
000000000000000000000000000000001h0000000000000000hh0000o00000000000010000000000000i0000000000o0v0000000000iiiiiiiiii00000000000
000000000000000000000000000000001h000000000000000000hh00800000000000001000000000000i0000000000o0v000000000000ii00000000iiiiiiiii
000000000000080000000000000000010h00000000000000000000ho8000i00000000001000000000000i000000000o00v0000000000000000000000iiiiiiii
000000000000000000000000000000111h00000000000000000000008h00i00000000000100000000000i000000000o00v000000000ii0000000000000000000
0000000000000000000000000000011110h00000000000000000000800hi0000000000000100000000000i000000000o88v00000000i00000000000000000000
0000000000000000000000000000010110h000000000000000000008000ih000001000000010000000000i000000000o00880000000000000000000000000000
0000000000000000000000000000011100h0000000000000000000o800i00hh00100000000100000000000i00000000o00008800000000000000000000000000
0000000000000000000000000000011000h00000000000000000000800i0000hh100000000010000000000i00000000o00000080000000000000000000000000
000000000000000000000000000001100ih0000000000000000000800i0000001h000000000010000000000i00000000o0000080000000000000000000000000
0000000000000000000000000000010ii00h00000000000000000o800i00000010hh0000000001000000000i00000000o0000080000000000000000000000000
000000000000000000000000000001i0000h00000000000000000o800i0000010000hh00000000100000000i00000000o0000080000u00000000000000000000
0000000000000000000000000000ii00000h00000000000000000o80i0000001000000hh00h0000100000000i0000000o0000080000u00000000000000000000
00000000000000000000000000ii0000000h0000000000000000o800i000001000000000hh00000100000000i00000000o000008000u00000000000000000000
0000000000000000000000000i000000000h0000000000000000o80i00000010000000000hh00000100000000i0000000o000008u00u00000000000000000000
0000000000000000000000000i000000000h0000000000000000o80i0000010000000000h00hh000010000000i0000000o000008u00000000000000000000000
00000000000000000000000000i000000000h000000000000000o80i000001000000000h00000hh00010000000i000000o0000080u0000000000000000000000
00000000000000000000000000i000000000h00000000000000o08i0000010000000000h0000000hh001000000i0000000o0000800u000000000000000000000
000000000000000000000000000i00000000h00000000000000o80i000010000000000h0000000000hh01000000i000000o00008000u00000000000000000000
000000000000000000000000000i00000000h00000000000000o8i000001000000000h0000000000000h1000000i000000o00008000u00000000000000000000
0000000000000000000000000000i0000000h0000000000000o08i00001000000000h0000000000000h001000000i00000o00008000u00000000000000000000
0000000000000000000000000000i0000000h0000000000000o08000001000000000h000000000000h0000100000i000000o0008000u00000000000000000000
00000000000000000000000000000i0000000h000000000000o8i00001000000000h000000000000h000000100000i00000o0000800uu0000000000000000000
00000000000000000000000000000i0000000h00000000000o08i0000100000000h0000000000000h000000010000i00000o0000800uu0000000000000000000
000000000000000000000000000000i000000h00000000000o0800001000000000h000000000000h00000000010000i0000o0000800uu0000000000000000000
000000000000000000000000000000i000000h00000000000o080000100000000h000000000000h000000000010000i00000o000800uvv000000000000000000
000000000000000000000000000000i000000h00000000000o08000100000000h000000000000h0000000000001000i00000o000800uvv000000000000000000
0000000000000000000000000000hh0i00000h0000000000o080000100000000h00000000000h000000000000001000i0000o000800uvvo11000000000000000
000000000000000000000000000hh00i000000h000000000o08000100000000h00000000000h0000000000000000100i0000o000800uvv0000i0u00000000000
00000000000000000000000000000000i00000h000000000oi800010000000h00000000000h000000000000000010000i0000o00800uvv00uuuoo00000000000
000o00000000000000000000000000h0i00000h00000000o0080010000000h00000000000h0000000000000000100000i0000o00800uvvuu0oo0000000000000
00o00000000000000000000000000h000i0000h00000000oi800100000000h00000000000h00000000000000010000000i000o00080uvv0oovv0000000000000
o000000000000000o00000000000h00hii0000h00000000oi80010000000h00000000000h000000000000000100000000i000o00080uv0oi0000000000000000
0000000000000000000000000000i00i00i0000h000000o008010000000h00000000000h00000000000000010000000000i000o0080uv0000000000000000000
00000000000000000i000000000000i00ii0000h000000oi08010000000h0000000000h000000000000000100000000000i000o0080uvho008oo800000000000
000000000000000000000000000000i0ih0i000h000000oi8010000000h0000000000h00000000000000110000000000000i00o0080uu00ooo00000000000000
000000000000o0000000000000000ihihhii000h000000o0801000000h0000000000h000000000000001000000000000000i00o0080uu000o000000000000000
00000000000000000000000000000i0ihi00i00h00000oi0810000000h000000000h00000000000000100000000000000000i00o080uu0000ovvv00000000000
0000000000000000000000000000i0ih0ihii00h00000o0001000000h0000000000h00000000000001000000000000000000i00o080u0u800oo0000000000000
000000000000i000000000000000h0h0h0h0i000h0000o001000000h0000000000h0000000000000100000000000000000ii000o080u8uo0o800088000000000
00000000000000000000000ih00hh00hh00hhi00h000oi001000000h000000000h0000000000000100000000000000000i00000o008u8u000000000000000000
0000000000000000000000000000000000000i00h000o001000000h000000000h0000000000000100000000000000000i0000000o08u8u000000000000000000
00000000000000000000000000h0hh000h000ii0h000i01000000h000000000h000000000000010000000000000000ii00000000o08u8u000000000000000000
00000000000000000000000000h0h0h0h0h0hii0h00i00100000h000000000h000000000000010000000000000000i0000000000o08u8u800000000000000000
0000o0000000000000000000000hh00hh00hhiiih00i01000000h00000000h000000000000010000000000000000i00000000000o08u8uo00000000000000000
000000000000000000000000000000000000000i0hi00100000h00000000h00000000000001000000000000000ii0000000000000o8u08o00000000000000000
00000000000000000000000000h0hh000h000h10ihi0100000h000000000h0000000000001000000000000000i000000000000000o8u08800000000000000000
0000000000000000000000000000ihhi0i0ih01iih00100000h00000000h000000000000100000000000000ii00000000000000oo08008000000000000000000
000000000000000000000000000i0h0ihi0ih0i10h0100000h00000000h000000000001100000000000000i00000000000000oo0008008080800000000000000
000000000000000000000000000i00i0i00i01i1ih010000h00000000h000000000001000000000000000i00000000000000o000000808080800000000000000
000000i0000000000000000000i00h00hhi0h0ijii100000h0000000h00000000000100000000000000ii0000000000000oo0000000808080080000000000000
00000000000000000000000000i000h0h0i0hih1ih10000h0000000h00000000000100000000000000i0000000000000oo000000000800808880000000000000
0000000000000000000000000000000hhi0hhi0ih1h000h0000000h00000000000100000000000000i0000000000000o00000000000800808000000000000000
000000000000000000000000000000000i000i0ihhh00h00000000h000000000010000000000000ii000000000000oo000000000008800888000000000000000
00000000000000000000000000000h00hi00ih0i0hh00h0000000h000000000010000000000000i000000000000oo00000000000880u088u0000000000000000
000000000000000000000000000000h0i000h000hhh0h0000000h00000000001000000000000ii000000000000o0000000000088000u8uu0u000000000000000
0000000000000000000000000000000hi000h000hh0h0000000h00000000001000000000000i000000000000oo00000000008800000u0uu0uuu0000000000000
0000000000000000i00i00000000000i0000h000h00h000000h00000000001000000000000i00000000000oo0000000000880000000u0uu0u000000000000000
ii00000000000000000i00000000ih0ihh000h000hhh00000h0000000000100000000000ii00000000000o00000000008800000000uu0uuuu000000000000000
iii000000000000000i00i000000i0hih000h000h0hh0000h0000000000100000000000i00000000000oo0000000008800000000uuv0uuu00000000000000000
000000000000000000000i00000000ihh000h000hh0h000h0000000000100000000000i0000000000oo000000000880000000uuu0vvu00000000000000000000
00000000000000000000i000000000i00000h000h00h000h10000000010000000000ii0000000000o000000000880000000uuvvvvvvv00000000000000000000
00000000ii0000000000i000000000000h000h000h00h0hi1000000110000000000i0000000000oo0000000088000000uuuvvvvvvvvv00000000000000000000
00000000iii00000000i000i000000000i00i0h0h000hh0i100000100000000000i0000000000o000000008800000uuuvvvvvvv0000000000000000000000000
00000000iii00000000i000i000000000i00i0h0h000h0001000010000000000ii000000000oo00000008800000uuvvhh0000000000000000000000000000000
00000000iii00000000i00i0000000000i00i000h000h000100010000000000i000000000oo0000000880000uuu0000000000000000000000000000000000000
0000000000000000000i000000000000i00i00000h000h001001000000000ii000000000o0000000880000uuh0h00h000h000000000000000000000000000000
0000000000000000000iiiii00000iiiiiiii0h0h000h000101000000000i000000000oo00000088000uuuh00hh0h0h0h0h00000000000000000000000000000
0000iiiiiiiiii000iiiiiiiiiiii0000ii00ii0h000h00011i00000000i00000000oo00000088000uuhh00hh00hh00hh0000000000000000000000000000000
0000iiiiiiiiiiiiii000000000000000iiii000h000h0001ii000000ii00000000o0000008800uuu00000000000000000000000000000000000000000000000
000000000000000000i0000000000000i00iiii00h000h00ihii0000i00000000oo00000880uuu000h00hh00h000000000000000000000000000000000000000
000000000000000000000000000000000ii00iiii0hii000h0ii000io000000oo00000880uu0h0h0h0h0h0h00000000000000000000000000000000000000000
00000000000000000000000000000000i00ii00ihiihhiihh0ihiii0o00000o0000088uuu00hh00hh00hh00h0000000000000000000000000000000000000000
0000o0000000000000000000000000000ii00i00ii0ii00ii000i00o0o00oo000088uu0i00000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000i00000ii00ii0ii0hii00h0o0ooo080088uuhhiihh000h000h0000000000000000000000000000000000000000000000
0000i00000000000000000000000000i0ii0ii00ii00ii0ii00iii00ho00008800h000i00000h0h0h00000000000000000000000000000000000000000000000
00ii0000000000000000000000000000000000ii00ii00ii0i0hh0iih0000000000000i000000000000000000000000000000000000000000000000000000000
0000i00000000000000000000000000000000i00i000i000ii0000000000000000000ii000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000i00ii00ii000i00ii0000000000hh00i0000000000000000000000000000000000000000000000000000000000
000i000000000000000000000000000000000i0ii00ii0000000000i0000000000h00i0000000000000000000000000000000000000000000000000000000000
0000i000000000000000000000000000000000i00i00000000000ii0000000000000ii0000000000000000000000000000000000000000000000000000000000
000i000000000000000000000000000000000i0ii0i0000000000000000000000i00i00000000000000000000000000000000000000000000000000000000000
0000i000000000000000000000000000000000i00i000000000000000000000000iii00000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000iiii000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000i000ii0000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000i0000000000000ii00000000000000000000000000000000000000000000000000000000000
0000000000i0ii0000000000000000000000000000000000000000i000000000000i0ii000000000000000000000000000000000000000000000000000000000
000000000i0i000000000000000000000000000000000000000000000000000000i0000ii0000000000000000000000000000000000000000000000000000000
0000000000ii000000000000000000000000000000000000000000000000000iiii0000000000000000000000000000000000000000000000000000000000000
000000000i000000000000000000000000000i000000000i0000000000000000iii00000000000000ii000000000000000000000000000000000000000000000
00000000000000000000000000000000000000i000000000i00000000000000iiii0000000000ii0000iii000000000000000000000000000000000000000000
000000ii0i00000000000000000000000000i00ii0i000i000000000000000iiii00000000i00000000000ii0000000000000000000000000000000000000000
00000000ii000000000000000000000000000i000000000i00000000000000i0ii0000000000000000000000ii00000000000000000000000000000000000000
00ii0ii0000000000000000000000000000000i000000000i00000000000000iiiii000ii0000000000ii00000ii000000000000000000000000000000000000
0000ii0ii000000000000000000000000000000i00000000000000000000000ii00000000i00000000000ii00000ii0000000000000000000000000000000000
000000ii0i000000000000000000000000000000i0000000000000000000000ii000000000i000000000000ii00000ii00000000000000000000000000000000
00000000ii0000000000000000000000000000i00000000000o000000000000ii0000000000000000000000000i00000ii000000000000000000000000000000
0000000000ii0ii000000000000000000000000000000000000000000000000i000000000i00000000000000000ii00000ii0000000000000000000000000000

