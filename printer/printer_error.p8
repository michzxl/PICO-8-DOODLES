pico-8 cartridge // http://www.pico-8.com
version 27
__lua__

function _init()
	t=0
	cls()
end

function _update()
	t+=1/60
end

function _draw()
	cls()

	circ(64,64,1,10)

	fang=function(char,i,x,y)
		return  cos(x/8/64 - y/8/128 - t/6)
	end
	fpos=function(char,i,x,y,a,w,dx,dy)
		return 0, cos(x/128 - t)*3
	end

	for y=0,128-8,8 do
		rprint("hellookay",0,y,0,1,{
			ang=fang,
			pos=fpos,
		},0)
	end
end
-- fs: (all members have signature f(char,i,x,y,a,dx,dy))
--		pos: -> x,y (draw pos offset)
--		ang: -> a (angle offset)
ord_ofs=97
special_chars={"\n",}
function rprint(s,dx,dy,a,w,fs,trans)
	f_ang=fs.ang or function() return 0 end
	f_pos=fs.pos or function() return 0,0 end
	a=a or 0
	w=w or 1

	x,y=dx,dy
	i=1
	while i<=#s do 
		printh(s)
		char = sub(s,i,i)

		while char=='\n' do
			i+=1
			x=dy
			y+=w*8
			char = sub(s,i,i)
		end

		sid = ord(char) - ord_ofs
		sx,sy = flr(sid%16)*8, sid\16*8
		
		af = a + f_ang(char,i,x,y,a,w,dx,dy)

		ofsx,ofsy=f_pos(char,i,x,y,a,w,dx,dy)
		xf,yf=x+ofsx,y+ofsy

		rspr(sx,sy,xf,yf,af,w,0)

		x+=w*8
		i+=1
	end
end

function find_str(str,look)
	for i=1,#str-#look+1 do
		test=sub(str,i,i+#look-1)
		if look==test then return i end
	end
	return false
end

function rspr(sx,sy,x,y,a,w,trans)
	local ca,sa=mcos(a),msin(a)
	local srcx,srcy
	local ddx0,ddy0=ca,sa
	local mask=shl(0xfff8,(w-1))
	w*=4
	ca*=w-0.5
	sa*=w-0.5
	local dx0,dy0=sa-ca+w,-ca-sa+w
	w=2*w-1
	for ix=0,w do
		srcx,srcy=dx0,dy0
		for iy=0,w do
			if band(bor(srcx,srcy),mask)==0 then
				local c=sget(sx+srcx,sy+srcy)
				if c~=trans then
				pset(x+ix,y+iy,c)
				end
			end
			srcx-=ddy0
			srcy+=ddx0
		end
		dx0+=ddx0
		dy0+=ddy0
	end
end

mcos=(function()
	cache={}
	return function(a)
		a %= 1
		if not cache[a] then
			cache[a]=cos(a)
		end
		return cache[a]
	end
end)()

msin=(function()
	cache={}
	return function(a)
		a %= 1
		if not cache[a] then
			cache[a]=sin(a)
		end
		return cache[a]
	end
end)()

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000077777000077770007777000077777700777777000777700077007700777777000000770077007700770000007700070077007700777777007777700
00777700077007700770077007707700077000000770000007700770077007700007700000000770077077000770000007770770077707700770077007700770
07700770077777000770000007700770077777000777770007700000077007700007700000000770077770000770000007777770077777700770077007700770
07700770077007700770000007700770077000000770000007707770077777700007700000000770077770000770000007707070077777700770077007777700
07777770077007700770077007707700077777700770000007700770077007700007700007700770077077000770000007700070077077700770077007700000
07700770077777000077770007777000077777700770000000777770077007700777777000777700077007700777777007700070077007700777777007700000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777700077777000077777007777770077007700770077007700070077007700770077007777770000000000000000000000000000000000000000000000000
07700770077007700777000000077000077007700770077007700070077007700770077000007700000000000000000000000000000000000000000000000000
07700770077007700077770000077000077007700770077007700070000770000077770000077000000000000000000000000000000000000000000000000000
07707770077777000000077000077000077007700777777007707070000770000007700000770000000000000000000000000000000000000000000000000000
07777700077077700000077000077000077007700077770007777770077007700007700007700000000000000000000000000000000000000000000000000000
00770770077007700777770000077000007777000007700007770770077007700007700007777770000000000000000000000000000000000000000000000000
