pico-8 cartridge // http://www.pico-8.com
version 30
__lua__

#include vec.lua
#include tex.lua
#include _2_util.lua
#include subpixel2.lua

local t=0
orot = 0

local gen = (function()
	local i=0
	return function()
		i=i+1
		if i%3==0 then
			return 0b11110001
		elseif i%3==1 then
			return 0b11110010
		else
			return 0b11110100
		end
	end
end)

pal({
	[0]=0,
	8+128,
	3,
	4,
	12+128,
	2,
	3+128,
	6+128,
},1)

function _init()
	ttonum(torus)

	tet = {
		v = {
			vec(1, 1, 1),
			vec(ヌ☉★1, ヌ☉★1, 1),
			vec(ヌ☉★1, 1, ヌ☉★1),
			vec(1, ヌ☉★1, ヌ☉★1),
		},
		l={
			{1,2},
			{2,3},
			{3,4},
			{1,4},
			{1,3},
			{2,4},
		},
		f={
			{1,2,3, },
			{1,2,  4},
			{1,  3,4},
			{  2,3,4},
		},
	}
	local tot =
		  vec(1, 1, 1)
		+ vec(ヌ☉★1, ヌ☉★1, 1)
		+ vec(ヌ☉★1, 1, ヌ☉★1)
		+ vec(1, ヌ☉★1, ヌ☉★1)
	avg = tot / 4
end

function _update()
	t+=1/30
	cls()

	local x,y
	x=64
	y=64

	local f = circfill

	g=gen()
	for i=0,2 do
		poke(0x5f5e,g())
		local ang = i/3+t/8
		local r = 32
		local pos = vec.frompolar(ang,r)
		local dir = pos:norm()*64
		pos += vec(64,64)
		local prp = dir:perp()

		for m=1,0,-1/10 do
			-- local p1 = pos + dir*m + prp*m*(sin(i/3+t/8))
			-- local p2 = pos - dir*m + prp*m*(sin(i/3+t/8))
			-- local p3 = pos - dir*m - prp*m*(sin(i/3+t/8))
			-- local p4 = pos + dir*m - prp*m*(sin(i/3+t/8))

			local p1 = pos + dir*m + prp*m
			local p2 = pos - dir*m + prp*m
			local p3 = pos - dir*m - prp*m
			local p4 = pos + dir*m - prp*m

			line(p1.x,p1.y,p2.x,p2.y,15)
			line(p2.x,p2.y,p3.x,p3.y,15)
			line(p3.x,p3.y,p4.x,p4.y,15)
			line(p4.x,p4.y,p1.x,p1.y,15)
			--trifill(p1,p2,p3,15)
			--trifill(p1,p3,p4,15)
		end
	end

	orot += rnd(0.00)
	local us = vec(-t/8,t/12,-t/8):u_rot_yxz()
	local scale = vec.one()*128
	local trans = vec(64,64,0)

	local vs = {}
	for v in all(tet.v) do
		local v = v - avg
		local nv = us:dot(v:scale(scale)) + trans

		add(vs,nv)
	end

	poke(0x5f5e,0b11111111)
	g = gen()
	--for i=1,t%3 do g() end
	for f in all(tet.f) do
		local buf = {}
		for vi in all(f) do
			add(buf, vs[vi])
		end
		poke(0x5f5e,g())
		--line(buf[1].x,buf[1].y,buf[2].x,buf[2].y,15)
		trifill(buf[1],buf[2],buf[3],0)
	end

	g = gen()
	for i=1,t%3 do g() end
	for f in all(tet.l) do
		local buf = {}
		for vi in all(f) do
			add(buf, vs[vi])
		end

		poke(0x5f5e,g())
		line(buf[1].x,buf[1].y,buf[2].x,buf[2].y,15)
	end
end

function ttonum(obj)
	for k,e in pairs(obj) do
		if type(e)=="table" then
			ttonum(e)
		elseif type(e)=="string" then
			obj[k] = tonum(e)
		end
	end
	return obj
end

function boxblur(x,y,width)
	sum=0
	count=(width*2+1)*(width*2+1)

	for xa=x-width,x+width,1 do
		for ya=y-width,y+width,1 do
			sum=sum+pget(xa,ya)
		end
	end

	return sum/count
end
__label__
0030000030000003333000030000000000000000ss000000000000o0000000000000000000000oo00oo000300000300000030000030000030000000300000000
003000003000000300000003000000000000000s0s000000000000o00000oo00000000000000000ooo0oo0300000300000030000030000003000000300000000
00300000300000030000003000000000000000s00s00000000000o000000o0oo000000000000000000oooo300000300000030000003000003000000300000000
0030000030000003000000300000000000000s000s00000000000o00000o0000ooo000000000000000000o4o0000300000030000003000003000000300000000
003000003000000030000300000000000000s0000s0000000000o000000o0000000ooo00000000000000000ooo00030000003000003000003000000300000000
0003000003000000300003000000000000ss000000s000000000o00000o00000000000oo000000000000000000oo030000003000003000003000000300000000
000300000300000030003000000000000s00000000s000000000o00000o0000000000000ooo00000000000000000o4o000003000003000003000000300000000
00030000030000003000300000000000s000000000s00000000o000000o0000000000000000ooo0000000000000004oooo003000003000003000000030000000
0003000003000000300030000000000s000000000ss00000000o00000o00000000000000000000oo000000000000000oo0oo3000000300000300000030000000
00030000030000003003000000000ss00000000ss00s000000o000000o000000oo00000000000000ooo00000000000000oo04oo0000300000300000030000000
0003000003000000030300000000s000000000s0000s000000o000000o000000o0oo000000000000000ooo0000000000000o030oo00300000300000030000000
000300000030000003300000000s000000000s00000s000000o00000o000000o0000ooo000000000000000oo000000000000o4000oo400000300000030000000
00003000003000000330000000s000000000s000000s00000o000000o000000o0000000ooo00000000000000ooo00000000000oo0003ooo00300000030000000
000030000030000003000000ss000000000s0000000s00000o00000o000000o00000000000oo000000000000000oo00000000000o003000oo300000003000000
00003000003000000300000s000000000ss00000000ss0000o00000o000000o0000000000000ooo00000000000000ooo000000000oo300000o4o000003000000
0000300000300000300000s000000000s000000000s0s000o000000o000000o0000000000000000oo000000000000000ooo00000000o40000030oo0003000000
000030000030000030000s000000000s000000000s00s000o00000o000000o0000000000000000000ooo000000000000000oo00000000oo0003000ooo3000000
0000300000300000300ss000000000s000000000s000s00o000000o000000o000000oo00000000000000ooo00000000000000ooo0000000o0030000004o00000
000003000003000300s000000000ss00000000ss0000s00o00000o000000o0000000o0oo000000000000000oo000000000000000ooo00000oo300000030ooo00
00000300000300030s000000000s000000000s0000000s0o00000o000000o000000o0000ooo00000000000000ooo000000000000000oo000004o0000003000oo
0000030000030030s000000000s000000000s00000000so000000o000000o000000o0000000ooo00000000000000oo000000000000000ooo0000o00000300000
00000300000300js000000000s000000000s000000000so00000o000000o000000o00000000000oo00000000000000ooo000000000000000ooo00oo000300000
0000030000030j000000000ss000000000s000000000sso00000o000000o000000o0000000000000ooo00000000000000ooo000000000000000oo00oo0300000
000003000003s300000000s000000000ss00000000ss02000000o000000o000000o0000000000000000oo000000000000000oo000000000000000ooo0o400000
00000030000s300000000s000000000s000000000s000os0000o000000o000000o0000000000000000000ooo00000000000000ooo000000000000000oo0o0000
0000003000s030000000s000000000s000000000s000o0s0000o000000o000000o00000oo000000000000000ooo00000000000000oo000000000000000oooo00
30000030ss00300000ss000000000s000000000s0000o0s000o000000o000000o000000o0oo0000000000000000oo00000000000000ooo000000000000000ooo
3000003s000300000s000000000ss00000000ss00000o0s000o000000o000000o00000o0000ooo000000000000000ooo00000000000000ooo000000000000000
300000j000030000s000000000s000000000s000000o00s000o000000o000000o00000o0000000ooo000000000000000oo000000000000000oo0000000000000
30000s300030000s000000000s000000000s0000000o000s0o000000o000000o000000o0000000000oo000000000000000ooo00000000000000ooo0000000000
300ss030003000s000000000s000000000s0000000o0s00s0o000000o000000o00000o0000000000000ooo000000000000000ooo00000000000000oo00000000
30s000030300ss00000000ss000000000s00000000os0s0s0o00000o0000000o00000o0000000000000000oo0000000000000000oo00000000000000ooo00000
0j000003030s000000000s000000000ss00000000s2000sso000000o000000o00000o0000000000000000000ooo000000000000000ooo00000000000000oo000
s300000303s000000000s000000000s000000000so0000s02000000o000000o00000o0000000000000000000000oo0000000000000000oo00000000000000ooo
030000033s000000000s000000000s000000000s0o000002s00000o000000o000000o000000oo0000000000000000ooo000000000000000ooo00000000000000
0300000jj00000000ss000000000s000000000s00o00000os00000o000000o00000o0000000o0oo00000000000000000ooo000000000000000oo000000000000
030000s300000000s000000000ss000000000s00o000000os0000o0000000o00000o000000o0000ooo00000000000000000oo000000000000000ooo000000000
03000s030000000s000000000s000000000ss000o00000o0s0000o000000o000000o000000o0000000ooo0000000000000000ooo000000000000000ooo000000
0030s030000000s000000000s000000000s0000o000000o00s000o000000o00000o000000o00000000000oo00000000000000000oo0000000000000000oo0000
00js003000000s000000000s000000000s00000o000s0o000s00o000000o000000o000000o0000000000000ooo0000000000000000ooo000000000000000ooo0
0s300300000ss00000000ss000000000s000000o00s0so000s00o000000o00000o0000000o0000000000000000oo00000000000000000oo0000000000000000o
s030030000s000000000s000000000ss000000o0ss0002000s00o000000o00000o000000o0000000000000000000ooo0000000000000000ooo00000000000000
003003000s000000000s000000000s00000000os0000o0s00s0o000000o000000o000000o000000oo00000000000000ooo0000000000000000ooo00000000000
00303000s000000000s000000000s00000000os00000o0s000so000000o00000o000000o0000000o0oo000000000000000oo00000000000000000oo000000000
003030ss000000000s000000000s0000000002000000o00s002000000o000000o000000o000000o0000ooo00000000000000ooo0000000000000000ooo000000
00030s000000000ss00000000ss000000000so00000o0000s02000000o000000o000000o000000o0000000ooo00000000000000ooo0000000000000000oo0000
0003s000000000s000000000s000000000sso000000o00000s2000000o00000o000000o000000o00000000000oo000000000000000oo0000000000000000ooo0
003s000000000s000000000s000000000s00o00000o000000os00000o000000o000000o000000o0000000000000ooo00000000000000ooo0000000000000000o
0sj000000000s000000000s000000000s000o000002000000o0s0000o00000o0000000o000000o0000000000000000oo000000000000000oo000000000000000
s300000000ss000000000s000000000s000o00000sos0000o00s000o000000o000000o000000o0000000000000000000ooo00000000000000ooo000000000000
030000000s000000000ss00000000ss0000o000sso00s000o00s000o000000o000000o000000o00000oo000000000000000ooo00000000000000ooo000000000
03000000s000000000s000000000s00000o000s00o000s00o00s000o00000o000000o000000o000000o0oo0000000000000000oo000000000000000oo0000000
3000000s000000000s000000000s000000o00s00o0000s0o0000s0o000000o000000o000000o00000o0000ooo000000000000000ooo00000000000000ooo0000
30000ss000000000s000000000s0000000o0s000o00000so0000s0o000000o000000o000000o00000o0000000ooo000000000000000ooo00000000000000oo03
0000s000000000ss000000000s0000000o0s0000o00000os0000so000000o000000o000000o000000o0000000000oo0000000000000000oo0000000000333333
000s000000000s000000000ss000000002s0000o000000o0s000so000000o000000o000000o00000o0000000000000ooo000000000000000ooo0003333000003
00s000000000s000000000s0000000002000000o000000o00s00so00000o000000o000000o000000o0000000000000000oo00000000000000333330030000003
0s000000000s000000000s000000000so000000o0s000o0000s0os00000o000000o000000o00000o0000000000000000000ooo00000003333030000030000000
s00000000ss000000000s000000000s0o00000o0s0s00o0000s0os00000o000000o000000o00000o000000oo00000000000000oo333330000030000003000000
00000000s000000000ss00000000ss0o0000002s000s0o00000sos0000o000000o000000o000000o000000o0oo00000000033333000030000003000003000000
0000000s000000000s000000000s000o0000020000002000000oss0000o000000o000000o00000o000000o0000ooo00333300300000003000003000003000000
000000s000000000s000000000s0000o0000so0000002000000o0s0000o00000o000000o000000o000000o000033333000000030000003000003000003000000
00000s000000000s000000000s0000o0000s0o00000o0s0000o000s00o000000o000000o000000o000000o333300000000000030000003000003000003000000
000ss00000000ss000000000s00000o000s0o000000o00s000o000s00o000000o000000o00000o00033333000000000000000030000003000003000003000000
00s000000000s000000000ss00000o00ss00o000000o000s00o000s0o000000o000000o000003433300000000000000000033330000003000003000003000000
0s000000000s000000000s0000000o0s000o000000o00000so0000s0o000000o000000o033330000000000000000033333300000000003000000300000300000
s000000000s000000000s00000000os0000o00000so00000020000s0o000000o0003333300000000000000033333300000000000000000300000300000300000
000000000s000000000s00000000os00000o0000sos00000o0s00002000000433330000000000000033333300000000000000000000000300000300000300000
0000000ss000000000s000000000200000o000ss0o0s0000o0s00002003333000000000000333333300000000000000000000000000000300000300000300000
000000s000000000ss00000000s2000000o00s000o0s0000o00s033j330000000000333333000000000000000000000000000000000333300000300000300000
00000s000000000s000000000s0o000000o0s000o000s00o0333j00s000000333333000000000000000000000000000000000333333000000000300000300000
0000s000000000s000000000s00o00000o0s0000o0003j3330000s0s333333000000000000000000000000000000000333333000000000000000030000030000
00ss000000000s000000000s00o0000002s00004333300s0000000s0s00000000000000000000000000000003333333000000000000000000000030000030000
0s000000000ss000000000s000o00000200333300000000s0000000ss00000000000000000000000003333330000000000000000000000000000030000030000
s000000000s000000000ss0000o0003j333000000000000s00000000s00000000000000000003333330000000000000000000000000000000033330000030000
000000000s000000000s00000o3333s000000000s0000000s0000000s00000000000033333330000000000000000000000000000000033333300000000030000
00000000s000000000s003333300ss000000000s0s0000000s0000000s0000033333300000000000000000000000000000000033333300000000000000030000
0000000s000000003j333000000s000000000ss000s0000000s000000j3333300000000000000000000000000000000333333300000000000000000000003000
00000ss000003333s000000000s000000000s00000s00000000s00000s0000000000000000000000000000000333333000000000000000000000000000003000
0000s003333300ss000000000s000000000s0000000s0000000s00000s0000000000000000000000000333333000000000000000000000000000000000003000
000j333000000s000000000ss000000000s000000000s0000000s0000s0000000000000000003333333000000000000000000000000000000000000003333000
3330s0000000s000000000s000000000ss00000000000s0000000s0000s000000000003333330000000000000000000000000000000000000003333330000000
00000s0000000s0000000s000000000s00000000000000s0000000s000s000003333330000000000000000000000000000000000000003333330000000000000
00000s00000000s0000000s0000000s000000000000000s00000000s00j333330000000000000000000000000000000000000003333330000000000000000000
000000s0000000s00000000s0000000s0000000s0000000s0000000s00s000000000000000000000000000000000000033333330000000000000000000000000
0000000s0000000s0000000s00000000s000000000000000s0000000s0s000000000000000000000000000000033333300000000000000000000000000000000
s0000000s0000000s0000000s0000000s00000000000000s000000000s0s00000000000000000000000033333300000000000000000000000000000000033334
s00000000s0000000s0000000s0000000s00000000000ss000000000s00s000000000000000003333333000000000000000000000000000000000333333000o0
0s0000000s00000000s0000000s0000000s000000000s000000000ss000s00000000000333333000000000000000000000000000000000333333300000000o00
00s0000000s0000000s00000000s0000000s0000000s000000000s00000s0000033333300000000000000000000000000000000033333300000000000000o0s0
000s0000000s0000000s0000000s00000000s00000s000000000s000000s333330000000000000000000000000000000003333330000000000000000000o000s
0000s0000000s0000000s0000000s0000000s000ss000000000s00000000s0000000000000000000000000000003333333000000000000000000000000o0000s
0000s00000000s0000000s0000000s0000000s0s000000000ss00000000ss0000000000000000000000003333330000000000000000000000000000000o00000
00000s0000000s00000000s0000000s0000000s000000000s00000000ss0s000000000000000000333333000000000000000000000000000000000000o00000o
000000s0000000s0000000s00000000s000000000000000s00000000s000s00000000000333333300000000000000000000000000000000000000000oo00000o
s000000s0000000s0000000s0000000s00000000000000s00000000s00000s000033333300000000000000000000000000000000000000000000000oo00000s2
0ss00000s0000000s0000000s0000000s00000000000ss00000000s000000j33330000000000000000000000000000000000000000000000000000o0o0000so0
s00s0000s00000000s0000000s0000000s000000000s000000000s0000000s0000000000000000000000000000000000000000000000000000000o0o0000s0o0
0s00s0000s0000000s00000000s0000000s0000000s00000000ss00000000s0000000000000000000000000000000000000000000000000000000o0o000s00o0
00s03ss000s0000000s0000000s00000000s00000s00000000s000000000ss000000000000000000000000000000000000000000000000000000o00o0ss00o00
000s300s000s0000000s0000000s0000000s000ss00000000s000000000s00s0000000000000000000000000000000000000000000000000000o00o0s0000o00
000s3000s000s0000000s0000000s0000000s0s000000000s000000000s000s000000000000000000000000000000000000000000000000000o000os0000o000
0000s3000ss0s00000000s0000000s0000000s000000000s000000000s0000s00000000000000000000000000000000000000000000000000o000os00000o000
00000j00000s0s0000000s00000000s00000000000000ss00000000ss00000s0000000000000000000000000000000000000000000000000o00002000000o000
000003s00333s0s0000000s0000000s0000000000000s000000000s0000000s000000000000000000000000000000000000000000000000o000sso00000o0000
0000033j30000sss0000000s0000000s00000000000s000000000s000000000s00000000000000000000000000000000000000000000000o00s0o000000o0000
0000000s00000o0ss0000000s0000000s000000000s000000000s000000000ss0000000000000000000000000000000000000000000000o00s00o00000o00000
s0000000s0000o00s00000000s0000000s0000000s000000000s000000000s0s000000000000000000000000000000000000000000000o00s000o00000o00000
0s0000000s000o000s0000000s00000000s0000ss00000000ss00000000ss00s00000000000000000000000000000000000000000000o0ss000o000000o00000
00s0000000s0o00000ss000000s0000000s000s000000000s000000000s0000s0000000000000000000000000000000000000000000o0s00000o00000o000000
00s00000000so000000ss000000s0000000s0s000000000s000000000s000000s00000000000000000000000000000000000000000o0s00000o000000o000000
000s0000000200000000ss000000s0000000s000000000s000000000s0000000s0000000000000000000000000000000000000000o0s000000o00000o000000o
0000s000000o20000000s0ss00000s000000000000000s000000000s00000000s0000000000000000000000000000000000000000os0000000o00000o000000o
00000s00000002o000000s00s0000s0000000000000ss00000000ss00000000ss000000000000000000000000000000000000000oo0000000o000000o000000o
000000s0000000sooo0000s00s0000s00000000000s000000000s000000000s0s00000000000000000000000000000000000000o00ooo0000o00000o000000o0
000000s00000000s00ooo00s00ss000s000000000s000000000s000000000s000s000000000000000000000000000000000000o000000oo0o000000o000000o0
0000000s0000000s00000oo0s000s000s0000000s000000000s000000000s0000s00000000000000000000000000000000000o000000000oo000000o00000o00
s0000000s0000000s000000o2o000s000s00000s000000000s000000000s00000s0000000000000000000000000000000000o00000000000000000o000000o00
0s0000000s0000000s0000000soo00s00s000ss00000000ss00000000ss000000s000000000000000000000000000000000o000000000000000000o000000o00
0s00000000s0000000s0000000s0oooss0s0s000000000s000000000s000000000s00000000000000000000000000000000ooo000000000000000o000000o000
00s0000000s00000000s0000000s000oos0s000000000s000000000s000000000ss0000000000000000000000000000000o000oo0000000000000o000000o000
000s0000000s0000000s00000000s0000os000000000s000000000s000000000s0s000000000000000000000000000000o000000ooo0000000000o000000o000
0000s0000000s0000000s0000000s000000ss00000ss00000000ss000000000s00s00000000000000000000000000000o0000000000oo0000000o000000o0000
00000s0000000s0000000s0000000s0000000s000s000000000s000000000ss000s0000000000000000000000000000o0000000000000ooo0000o000000o0000
00000s00000000s0000000s0000000s0000000s0s000000000s000000000s000000s00000000000000000000000000o0o000000000000000oo0o000000o00000
000000s0000000s00000000s0000000s0000000ss00000000s000000000s0000000s0000000000000000000000000o000ooo00000000000000oo000000o00000
0000000s0000000s0000000s00000000s00000s00s000000s000000000s00000000s0000000000000000000000000o000000oo00000000000000000000o00000
s0000000s0000000s0000000s0000000s000ss0000s000ss00000000ss000000000s000000000000000000000000o000000000ooo0000000000000000o000000

